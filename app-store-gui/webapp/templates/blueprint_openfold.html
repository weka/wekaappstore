<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>OpenFold Protein Prediction - Blueprint</title>
  {% if logo_b64 %}
    <link rel="icon" type="image/png" href="data:image/png;base64,{{ logo_b64 }}">
  {% endif %}
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/react@18/umd/react.development.js" crossorigin></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js" crossorigin></script>
  <script src="https://unpkg.com/@emotion/react@11.11.4/dist/emotion-react.umd.min.js" crossorigin></script>
  <script src="https://unpkg.com/@emotion/styled@11.11.0/dist/emotion-styled.umd.min.js" crossorigin></script>
  <script src="https://unpkg.com/@mui/material@5.15.14/umd/material-ui.development.js" crossorigin></script>
  <style>
    :root { --weka-purple: #6b2fb3; --weka-purple-dark: #552695; --weka-dark: #0B0C10; }
    body { background: #0b0c10; color: #e5e7eb; font-family: 'Inter', ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, 'Apple Color Emoji', 'Segoe UI Emoji'; }
    .brand-grad { background: linear-gradient(135deg, #1f2937 0%, #0b0c10 100%); }
    .card { background: rgba(31, 41, 55, 0.6); border: 1px solid rgba(255,255,255,0.06); backdrop-filter: blur(6px); }
    .btn-purple { background: var(--weka-purple); color: white; }
    .btn-purple:hover { background: var(--weka-purple-dark); }
    .muted { color: #9ca3af; }
    .badge { padding: 2px 8px; border-radius: 9999px; font-size: 12px; }
    /* Make permission badges smaller only within the Blueprint Permissions section */
    .perm-card .badge { padding: 1px 6px; font-size: 10px; line-height: 1.2; }
  </style>
  </head>
  <body class="min-h-screen">
    <header class="brand-grad border-b border-white/10">
      <div class="max-w-6xl mx-auto px-4 py-6 flex items-center justify-between">
        <div class="flex items-center gap-3">
          {% if logo_b64 %}
            <img src="data:image/png;base64,{{ logo_b64 }}" alt="WEKA App Store" class="w-12 h-12 rounded-sm object-contain bg-white/0" />
          {% else %}
            <div class="w-12 h-12 rounded-sm" style="background: var(--weka-purple);"></div>
          {% endif %}
          <a href="/" class="text-2xl font-semibold tracking-tight hover:underline">WEKA App Store</a>
        </div>
        <a href="/" class="text-sm text-white/80 hover:text-white">Back</a>
      </div>
    </header>

    <main class="max-w-6xl mx-auto px-4 py-8 space-y-8">
      <section class="grid grid-cols-1 lg:grid-cols-3 gap-6 items-start">
        <div class="lg:col-span-2 space-y-6">
          <div class="card rounded-lg p-6">
            <h1 class="text-2xl font-semibold mb-2">OpenFold Protein Prediction</h1>
            <div class="flex items-center gap-2 mb-3">
              <span class="badge" style="background: rgba(255,255,255,0.06); border: 1px solid rgba(255,255,255,0.08);">Open Source</span>
            </div>
            <p class="muted text-sm leading-6">OpenFold 2 is an open-source protein structure prediction framework that builds on the ideas of AlphaFold but is optimized for transparency, reproducibility, and large-scale training in research environments. It provides modular, well-documented components so scientists can study how protein-folding models work internally, customize them, or train new variants on their own datasets. People use OpenFold 2 because it offers high-quality structure prediction while remaining fully open, hackable, and suitable for experimentation in academic and industry research.</p>
            
          </div>

          <!-- Area 2: Installation Details -->
          <div class="card rounded-lg p-6">
            <h2 class="text-xl font-semibold mb-3">Installation Details</h2>
            <div class="space-y-4 text-sm muted leading-6">
              <p>
                WEKA’s implementation of OpenFold 2 has been enhanced to take advantage of WEKA’s industry-leading, POSIX-backed filesystem. In this blueprint, Argo Workflow Manager is used to orchestrate and schedule OpenFold runs. The blueprint includes two Argo workflow templates: <span class="font-medium text-white">pipeline</span>, which runs the OpenFold MSA and inference tasks on one or more proteins, and <span class="font-medium text-white">bootstrap</span>, which installs the required UniRef50 and PDB70 databases into your configured Persistent Volume for use during MSA analysis.
              </p>
              <p>
                Users may choose either to use the blueprint’s built-in database bootstrap process or to manually download and provide their own databases in the Persistent Volume.
              </p>
              <p>
                This blueprint is designed to work with the WEKA NeuralMesh CSI driver for Kubernetes. To install this blueprint, you must have both the WEKA Operator and the CSI driver configured and connected to your WEKA NeuralMesh cluster.
              </p>
              <p>
                A minimum of one NVIDIA GPU and four CPU-backed worker nodes is required to run the blueprint.
              </p>
              <p>
                To deploy the blueprint, fill in the necessary details in the Configure panel. For the <span class="font-medium text-white">WEKA Cluster Filesystem</span> setting, you must specify the exact filesystem configured for use with your WEKA CSI driver. Selecting any other WEKA NeuralMesh filesystem will result in deployment failure.
              </p>
            </div>
          </div>

          <!-- Area 3: Blueprint Permissions -->
          <div class="card rounded-lg p-6 perm-card">
            <h2 class="text-xl font-semibold mb-4">Blueprint Permissions</h2>
            <p class="text-sm muted mb-5">This blueprint uses a Service Account with the following roles. Permissions are scoped to the namespace where the blueprint is installed.</p>

            <div class="grid md:grid-cols-2 gap-6 text-base md:text-lg leading-7">
              <!-- Kubernetes -->
              <div>
                <h3 class="text-lg md:text-xl font-semibold mb-3">Kubernetes</h3>
                <div class="space-y-4">
                  <div>
                    <div class="text-white font-semibold text-base md:text-lg mb-2">Pods / Logs</div>
                    <div class="flex flex-wrap gap-1">
                      <span class="badge" style="background:#374151;">GET</span>
                      <span class="badge" style="background:#065f46; color:#d1fae5;">CREATE</span>
                      <span class="badge" style="background:#1e40af; color:#dbeafe;">UPDATE</span>
                      <span class="badge" style="background:#7f1d1d; color:#fee2e2;">DELETE</span>
                      <span class="badge" style="background:#4338ca; color:#e0e7ff;">PATCH</span>
                      <span class="badge" style="background:#374151;">LIST</span>
                      <span class="badge" style="background:#92400e; color:#ffedd5;">WATCH</span>
                    </div>
                  </div>
                  <div>
                    <div class="text-white font-semibold text-base md:text-lg mb-2">PVC &amp; ConfigMap</div>
                    <div class="flex flex-wrap gap-1">
                      <span class="badge" style="background:#374151;">GET</span>
                      <span class="badge" style="background:#065f46; color:#d1fae5;">CREATE</span>
                      <span class="badge" style="background:#1e40af; color:#dbeafe;">UPDATE</span>
                      <span class="badge" style="background:#7f1d1d; color:#fee2e2;">DELETE</span>
                      <span class="badge" style="background:#4338ca; color:#e0e7ff;">PATCH</span>
                      <span class="badge" style="background:#374151;">LIST</span>
                      <span class="badge" style="background:#92400e; color:#ffedd5;">WATCH</span>
                    </div>
                  </div>
                </div>
              </div>

              <!-- Argo -->
              <div>
                <h3 class="text-lg md:text-xl font-semibold mb-3">Argo</h3>
                <div class="space-y-4">
                  <div>
                    <div class="text-white font-semibold text-base md:text-lg mb-2">Workflow</div>
                    <div class="flex flex-wrap gap-1">
                      <span class="badge" style="background:#374151;">GET</span>
                      <span class="badge" style="background:#065f46; color:#d1fae5;">CREATE</span>
                      <span class="badge" style="background:#1e40af; color:#dbeafe;">UPDATE</span>
                      <span class="badge" style="background:#7f1d1d; color:#fee2e2;">DELETE</span>
                      <span class="badge" style="background:#4338ca; color:#e0e7ff;">PATCH</span>
                      <span class="badge" style="background:#374151;">LIST</span>
                      <span class="badge" style="background:#92400e; color:#ffedd5;">WATCH</span>
                    </div>
                  </div>
                  <div>
                    <div class="text-white font-semibold text-base md:text-lg mb-2">Workflow Templates</div>
                    <div class="flex flex-wrap gap-1">
                      <span class="badge" style="background:#374151;">GET</span>
                      <span class="badge" style="background:#065f46; color:#d1fae5;">CREATE</span>
                      <span class="badge" style="background:#1e40af; color:#dbeafe;">UPDATE</span>
                      <span class="badge" style="background:#7f1d1d; color:#fee2e2;">DELETE</span>
                      <span class="badge" style="background:#4338ca; color:#e0e7ff;">PATCH</span>
                      <span class="badge" style="background:#374151;">LIST</span>
                      <span class="badge" style="background:#92400e; color:#ffedd5;">WATCH</span>
                    </div>
                  </div>
                  <div>
                    <div class="text-white font-semibold text-base md:text-lg mb-2">CRONWorkflows</div>
                    <div class="flex flex-wrap gap-1">
                      <span class="badge" style="background:#374151;">GET</span>
                      <span class="badge" style="background:#065f46; color:#d1fae5;">CREATE</span>
                      <span class="badge" style="background:#1e40af; color:#dbeafe;">UPDATE</span>
                      <span class="badge" style="background:#7f1d1d; color:#fee2e2;">DELETE</span>
                      <span class="badge" style="background:#4338ca; color:#e0e7ff;">PATCH</span>
                      <span class="badge" style="background:#374151;">LIST</span>
                      <span class="badge" style="background:#92400e; color:#ffedd5;">WATCH</span>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <div class="card rounded-lg p-6">
            <h2 class="text-xl font-semibold mb-3">What this blueprint installs</h2>
            <ul class="list-disc ml-6 space-y-2 text-sm">
              <li>Openfold 2.1.1</li>
              <li>Argo Workflows v0.41.8</li>
              <li>WEKA Operator/CSI v1.8.7</li>
              <li>Mol Star Viewer</li>
            </ul>
            {% if yaml_path %}
            <div class="mt-3 text-xs muted">Manifest: {{ yaml_path }}</div>
            {% endif %}
          </div>
        </div>

        <div class="space-y-6">
          <div class="card rounded-lg p-6">
            <h2 class="text-lg font-semibold mb-4">Cluster Compatibility</h2>
            <div class="space-y-3 text-sm">
              <div class="flex items-center justify-between">
                <div>CPU worker nodes</div>
                <div class="flex items-center gap-2">
                  <span class="badge" style="background: rgba(255,255,255,0.06); border: 1px solid rgba(255,255,255,0.08);">need ≥ {{ requirements.cpu_nodes }}</span>
                  {% if meets.cpu is none %}
                    <span class="badge" style="background: #374151;">unknown</span>
                  {% elif meets.cpu %}
                    <span class="badge" style="background: #065f46; color: #d1fae5;">ok (have {{ status.cpu_nodes }})</span>
                  {% else %}
                    <span class="badge" style="background: #7f1d1d; color: #fee2e2;">insufficient (have {{ status.cpu_nodes }})</span>
                  {% endif %}
                </div>
              </div>
              <div class="flex items-center justify-between">
                <div>GPU worker nodes</div>
                <div class="flex items-center gap-2">
                  <span class="badge" style="background: rgba(255,255,255,0.06); border: 1px solid rgba(255,255,255,0.08);">need ≥ {{ requirements.gpu_nodes }}</span>
                  {% if meets.gpu is none %}
                    <span class="badge" style="background: #374151;">unknown</span>
                  {% elif meets.gpu %}
                    <span class="badge" style="background: #065f46; color: #d1fae5;">ok (have {{ status.gpu_nodes }})</span>
                  {% else %}
                    <span class="badge" style="background: #7f1d1d; color: #fee2e2;">insufficient (have {{ status.gpu_nodes }})</span>
                  {% endif %}
                </div>
              </div>
            </div>
          </div>

          <div class="card rounded-lg p-6">
            <h2 class="text-lg font-semibold mb-3">Configure</h2>
            {% include 'partials_deploy_form.html' ignore missing %}
            {% if not self %}{% endif %}
            <form id="deploy-form" class="space-y-4">
              <!-- Reordered fields as requested -->
              <div>
                <label class="block text-sm mb-1" for="deploymentName">Deployment Name</label>
                <input id="deploymentName" name="deploymentName" placeholder="e.g. openfold-prod"
                       class="w-full px-3 py-2 text-sm rounded-md bg-gray-800 border border-white/10 focus:outline-none focus:ring-2 focus:ring-yellow-400" />
                <div class="muted text-xs mt-1">Custom name to assign to this OpenFold deployment.</div>
              </div>

              <div>
                <label class="block text-sm mb-1" for="namespace">Namespace</label>
                <input id="namespace" name="namespace" placeholder="default" value="default"
                       class="w-full px-3 py-2 text-sm rounded-md bg-gray-800 border border-white/10 focus:outline-none focus:ring-2 focus:ring-yellow-400" />
                <div class="muted text-xs mt-1">Set the Kubernetes namespace for this deployment.</div>
              </div>

              <div>
                <label class="block text-sm mb-1" for="wekaClusterFilesystem">WEKA Cluster Filesystem</label>
                <input id="wekaClusterFilesystem" name="wekaClusterFilesystem" placeholder="e.g. weka-fs01"
                       class="w-full px-3 py-2 text-sm rounded-md bg-gray-800 border border-white/10 focus:outline-none focus:ring-2 focus:ring-yellow-400" />
                <div class="muted text-xs mt-1">Name or identifier of the WEKA cluster filesystem to use.</div>
              </div>

              <div>
                <label class="block text-sm mb-1" for="openfoldStorageCapacity">Openfold Storage Capacity</label>
                <input id="openfoldStorageCapacity" name="openfoldStorageCapacity" placeholder="e.g. 500Gi"
                       class="w-full px-3 py-2 text-sm rounded-md bg-gray-800 border border-white/10 focus:outline-none focus:ring-2 focus:ring-yellow-400" />
                <div class="muted text-xs mt-1">Requested capacity for OpenFold persistent storage (e.g., 100Gi, 1Ti).</div>
              </div>


              <button type="submit" class="btn-purple w-full px-4 py-2 rounded-md text-sm font-medium">Deploy Blueprint</button>
              <div id="deploy-result" class="text-xs mt-2"></div>
            </form>

            <div id="progress" class="mt-4 hidden">
              <h3 class="text-sm font-semibold mb-2">Installation Progress</h3>
              <ul id="progress-list" class="space-y-1 text-sm"></ul>
            </div>
          </div>
        </div>
      </section>
    </main>

    <footer class="max-w-6xl mx-auto px-4 py-8 muted text-xs"></footer>

    <script>
      async function get(url) { const res = await fetch(url); return res.json(); }
      function resolveNamespaceSync() { const saved = localStorage.getItem('selectedNamespace'); return saved && saved.trim() ? saved.trim() : null; }
      async function syncNamespaceField() {
        const nsInput = document.getElementById('namespace'); if (!nsInput) return 'default';
        let ns = resolveNamespaceSync();
        if (!ns) {
          try { const data = await get('/auth-status'); ns = (data && data.details && data.details.namespace) ? String(data.details.namespace) : null; if (ns && !localStorage.getItem('selectedNamespace')) { localStorage.setItem('selectedNamespace', ns); } } catch (_) {}
        }
        if (!ns) ns = 'default'; nsInput.value = ns; return ns;
      }
      document.addEventListener('DOMContentLoaded', async () => {
        await syncNamespaceField();
      });
      const form = document.getElementById('deploy-form');
      form.addEventListener('submit', async (e) => {
        e.preventDefault();
        const ns = (document.getElementById('namespace').value || (await syncNamespaceField()) || 'default');
        const resEl = document.getElementById('deploy-result');
        const progressEl = document.getElementById('progress');
        const listEl = document.getElementById('progress-list');
        resEl.textContent = 'Starting deployment...';
        listEl.innerHTML = '';
        progressEl.classList.remove('hidden');
        const params = new URLSearchParams();
        params.set('app_name', '{{ name }}');
        params.set('namespace', ns);
        const wekaFs = document.getElementById('wekaClusterFilesystem')?.value || '';
        if (wekaFs) params.set('weka_cluster_filesystem', wekaFs);
        const ofCap = document.getElementById('openfoldStorageCapacity')?.value || '';
        if (ofCap) params.set('openfold_storage_capacity', ofCap);
        const depName = document.getElementById('deploymentName')?.value || '';
        if (depName) params.set('deployment_name', depName);
        try {
          const resp = await fetch(`/deploy-stream/{{ name }}?${params.toString()}`);
          const reader = resp.body.getReader();
          const dec = new TextDecoder();
          while (true) {
            const { value, done } = await reader.read(); if (done) break; const chunk = dec.decode(value);
            for (const line of chunk.split('\n')) {
              if (!line.startsWith('data:')) continue; const jsonStr = line.substring(5).trim(); if (!jsonStr) continue;
              try { const evt = JSON.parse(jsonStr); if (evt.message) { const li = document.createElement('li'); li.textContent = evt.message; listEl.appendChild(li); listEl.scrollTop = listEl.scrollHeight; } } catch (_) {}
            }
          }
          resEl.textContent = 'Deployment stream finished.';
        } catch (err) {
          resEl.textContent = 'Error: ' + (err && err.message ? err.message : String(err));
        }
      });
    </script>
  </body>
  </html>
